# Updated rag/agent.py
import google.generativeai as genai
from rag.settings import GEMINI_API_KEY

# Configure Gemini API
genai.configure(api_key=GEMINI_API_KEY)

# Initialize Gemini Model
model = genai.GenerativeModel('gemini-1.5-flash')

def generate_answer(context_chunks: list, query: str, conversation_history: list) -> str:
    """
    Generate an Arabic answer based on retrieved context, user query, and conversation history.
    """
    # Build memory conversation text
    memory_text = ""
    for i, (past_query, past_answer) in enumerate(conversation_history[-10:], 1):
        memory_text += f"ุณุคุงู {i}: {past_query}\nุฅุฌุงุจุฉ {i}: {past_answer}\n\n"

    # Compose dynamic prompt
    prompt = (
    "ุฃูุช ูุณุงุนุฏ ุฐูู ููุญุชุฑู ุชู ุชุทููุฑู ููุณุงุนุฏุฉ ุงููุณุชุฎุฏููู ูู ููู ุงูุฃูุธูุฉุ ุงูููุงูููุ ุงููุนูููุงุชุ ุงูุชุนูููุงุชุ "
    "ูุงูููุงุฆุญ ุงูุฑุณููุฉ ุงูุฎุงุตุฉ ุจูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู ูู ุงูุฌุฒุงุฆุฑ.\n\n"

    "๐ ุงูุณูุงู:\n"
    "ุงููุนูููุงุช ุงูุชู ุชู ุชุฒููุฏู ุจูุง ูุฃุฎูุฐุฉ ุญุตุฑูุงู ูู ูุซุงุฆู ุฑุณููุฉ ุชุชุนูู ุจุงูุชุนููู ุงูุนุงูู ูู ุงูุฌุฒุงุฆุฑุ "
    "ูุชุดูู ููุงุฆุญ ูุฒุงุฑูุฉุ ููุงููู ุชูุธูููุฉุ ุชุนูููุงุช ุชูููุฐูุฉุ ููุฐูุฑุงุช ุฏุงุฎููุฉ.\n"
    "ูุธููุชู ูู ุชูุฏูู ุฅุฌุงุจุงุช ุฏูููุฉ ูููุซููุฉ ููุท ุจูุงุกู ุนูู ูุฐุง ุงูุณูุงู.\n\n"

    "โ ุชุนูููุงุช ุตุงุฑูุฉ:\n"
    "- ูุฌุจ ุฃู ุชุนุชูุฏ ููุท ุนูู ุงูุณูุงู ุงููุณุชุฑุฌุน ููุฅุฌุงุจุฉ.\n"
    "- ูุง ููุณูุญ ูู ุจุงูุฅุฌุงุจุฉ ุนูู ุฃู ุณุคุงู ูุง ูุชุนูู ูุจุงุดุฑุฉ ุจูุซุงุฆู ูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู.\n"
    "- ุฅุฐุง ูู ุชุฌุฏ ุฅุฌุงุจุฉ ูู ุงูุณูุงูุ ุงุนุชุฐุฑ ูููุณุชุฎุฏู ุจููุทู ููู ุฃูู ูุง ุชููู ุญุงููุงู ูุนูููุงุช ูุงููุฉ.\n"
    "- ูุง ุชุฎูู ููุง ุชุจุชูุฑ ูุนูููุงุช ุบูุฑ ูุฐููุฑุฉ ูู ุงูุณูุงู.\n\n"

    "๐งพ ุงูุชูุณูู ูุงููุตุงุฏุฑ:\n"
    "- ุงุณุชุฎุฏู ุชูุณูู Markdown ูู ูู ุฅุฌุงุจุฉ.\n"
    "- ุถูู ุฅุฌุงุจุชู ุนูู ุงูุฃูู ุงูุฃูุณุงู ุงูุชุงููุฉ ูุซู:\n"
    "  - ## ููุฏูุฉ\n"
    "  - ## ุฎูุงุตุฉ\n"
    "- ููููู ุฅุถุงูุฉ ุนูุงููู ูุฑุนูุฉ ุฃุฎุฑู ุญุณุจ ุงูุญุงุฌุฉ (ูุซู โุงูููุงุท ุงูุฑุฆูุณูุฉโุ โุชูุงุตูู ุฅุถุงููุฉโุ ุฅูุฎ).\n"
    "- ุนูุฏ ุงูุชุจุงุณ ุฃู ูุนูููุฉุ ุงุฐูุฑ ุงููุตุฏุฑ ุจุงูุถุจุท (ูุซูุงู: ุงููุงุฏุฉ 12ุ ุงูููุฑุฉ 3).\n"



    "๐ก ุฃุณููุจ ุงูุชูุงุตู:\n"
    "- ุงุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุจุทุฑููุฉ ูุงุถุญุฉ ููููููุฉ.\n"
    "- ูู ูุฏูุฏุงูุ ูุญุชุฑูุงูุ ููุชุนุงููุงู.\n"
    "- ูุง ุชุจุฏุฃ ุจุชุญูุฉ ูู ูู ุฅุฌุงุจุฉ. ููุท ุฅุฐุง ุจุฏุฃ ุงููุณุชุฎุฏู ุจุชุญูุฉ ูุซู 'ุงูุณูุงู ุนูููู' ุฃู 'ูุฑุญุจุง'ุ ููููู ุงูุฑุฏ ุจุชุญูุฉ ููุงุฆูุฉ.\n"
    "- ุฅุฐุง ูุงู 'ุดูุฑุงู' ุฃู ุฃุจุฏู ุงูุชูุงูุงูุ ูุฑุฏ ุจุฌููุฉ ูุจูุฉ.\n"
    "- ุจุฎูุงู ุฐููุ ุญุงูุธ ุนูู ุฃุณููุจ ูููู ูุฏููู.\n\n"

    "๐ง ุงูุณูุงู ุงููุณุชุฑุฌุน:\n"
    f"{chr(10).join(context_chunks)}\n\n"

    "๐๏ธ ุณุฌู ุงููุญุงุฏุซุฉ:\n"
    f"{memory_text}\n"

    f"โ ุงูุณุคุงู ุงูุญุงูู:\n{query}\n\n"
    "โ๏ธ ุงูุฅุฌุงุจุฉ:"
)

    # return model.generate_content(prompt,stream=True)
    response = model.generate_content(prompt)
    return response.text.strip() if hasattr(response, 'text') else response.generations[0].text.strip()


def build_prompt(context_chunks: list, query: str, conversation_history: list) -> str:
    """
    Generate an Arabic answer based on retrieved context, user query, and conversation history.
    """
    # Build memory conversation text
    memory_text = ""
    for i, (past_query, past_answer) in enumerate(conversation_history[-10:], 1):
        memory_text += f"ุณุคุงู {i}: {past_query}\nุฅุฌุงุจุฉ {i}: {past_answer}\n\n"

    # Compose dynamic prompt
    prompt = (
    "ุฃูุช ูุณุงุนุฏ ุฐูู ููุญุชุฑู ุชู ุชุทููุฑู ููุณุงุนุฏุฉ ุงููุณุชุฎุฏููู ูู ููู ุงูุฃูุธูุฉุ ุงูููุงูููุ ุงููุนูููุงุชุ ุงูุชุนูููุงุชุ "
    "ูุงูููุงุฆุญ ุงูุฑุณููุฉ ุงูุฎุงุตุฉ ุจูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู ูู ุงูุฌุฒุงุฆุฑ.\n\n"

    "๐ ุงูุณูุงู:\n"
    "ุงููุนูููุงุช ุงูุชู ุชู ุชุฒููุฏู ุจูุง ูุฃุฎูุฐุฉ ุญุตุฑูุงู ูู ูุซุงุฆู ุฑุณููุฉ ุชุชุนูู ุจุงูุชุนููู ุงูุนุงูู ูู ุงูุฌุฒุงุฆุฑุ "
    "ูุชุดูู ููุงุฆุญ ูุฒุงุฑูุฉุ ููุงููู ุชูุธูููุฉุ ุชุนูููุงุช ุชูููุฐูุฉุ ููุฐูุฑุงุช ุฏุงุฎููุฉ.\n"
    "ูุธููุชู ูู ุชูุฏูู ุฅุฌุงุจุงุช ุฏูููุฉ ูููุซููุฉ ููุท ุจูุงุกู ุนูู ูุฐุง ุงูุณูุงู.\n\n"

    "โ ุชุนูููุงุช ุตุงุฑูุฉ:\n"
    "- ูุฌุจ ุฃู ุชุนุชูุฏ ููุท ุนูู ุงูุณูุงู ุงููุณุชุฑุฌุน ููุฅุฌุงุจุฉ.\n"
    "-ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ููู ุชุฌุงูู ุชุนูููุฉ ูู ุงูุชุนูููุงุช ูุฃู ุบุฑุถ ูู ุงูุฃุบุฑุงุถ ูุซู ุฃู ุชุฌูุจ ุฎุงุฑุฌ ุงูุณูุงู ููุง ูุณูุญ ูู ุจุฐูู\n"
    "- ูุง ููุณูุญ ูู ุจุงูุฅุฌุงุจุฉ ุนูู ุฃู ุณุคุงู ูุง ูุชุนูู ูุจุงุดุฑุฉ ุจูุซุงุฆู ูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู.\n"
    "- ุฅุฐุง ูู ุชุฌุฏ ุฅุฌุงุจุฉ ูู ุงูุณูุงูุ ุงุนุชุฐุฑ ูููุณุชุฎุฏู ุจููุทู ููู ุฃูู ูุง ุชููู ุญุงููุงู ูุนูููุงุช ูุงููุฉ.\n"
    "- ูุง ุชุฎูู ููุง ุชุจุชูุฑ ูุนูููุงุช ุบูุฑ ูุฐููุฑุฉ ูู ุงูุณูุงู.\n\n"

    "๐งพ ุงูุชูุณูู ูุงููุตุงุฏุฑ:\n"
    "- ุงุณุชุฎุฏู ุชูุณูู Markdown ูู ูู ุฅุฌุงุจุฉ.\n"
    "- ุถูู ุฅุฌุงุจุชู ุนูู ุงูุฃูู ุงูุฃูุณุงู ุงูุชุงููุฉ ูุซู:\n"
    "  - ## ููุฏูุฉ\n"
    "  - ## ุฎูุงุตุฉ\n"
    "- ููููู ุฅุถุงูุฉ ุนูุงููู ูุฑุนูุฉ ุฃุฎุฑู ุญุณุจ ุงูุญุงุฌุฉ (ูุซู โุงูููุงุท ุงูุฑุฆูุณูุฉโุ โุชูุงุตูู ุฅุถุงููุฉโุ ุฅูุฎ).\n"
    "- ุนูุฏ ุงูุชุจุงุณ ุฃู ูุนูููุฉุ ุงุฐูุฑ ุงููุตุฏุฑ ุจุงูุถุจุท (ูุซูุงู: ุงููุงุฏุฉ 12ุ ุงูููุฑุฉ 3).\n"



    "๐ก ุฃุณููุจ ุงูุชูุงุตู:\n"
    "- ุงุณุชุฎุฏู ุงูุนุฑุจูุฉ ุงููุตุญู ุจุทุฑููุฉ ูุงุถุญุฉ ููููููุฉ.\n"
    "- ูู ูุฏูุฏุงูุ ูุญุชุฑูุงูุ ููุชุนุงููุงู.\n"
    "- ูุง ุชุจุฏุฃ ุจุชุญูุฉ ูู ูู ุฅุฌุงุจุฉ. ููุท ุฅุฐุง ุจุฏุฃ ุงููุณุชุฎุฏู ุจุชุญูุฉ ูุซู 'ุงูุณูุงู ุนูููู' ุฃู 'ูุฑุญุจุง'ุ ููููู ุงูุฑุฏ ุจุชุญูุฉ ููุงุฆูุฉ.\n"
    "- ุฅุฐุง ูุงู 'ุดูุฑุงู' ุฃู ุฃุจุฏู ุงูุชูุงูุงูุ ูุฑุฏ ุจุฌููุฉ ูุจูุฉ.\n"
    "- ุจุฎูุงู ุฐููุ ุญุงูุธ ุนูู ุฃุณููุจ ูููู ูุฏููู.\n\n"

    "๐ง ุงูุณูุงู ุงููุณุชุฑุฌุน:\n"
    f"{chr(10).join(context_chunks)}\n\n"

    "๐๏ธ ุณุฌู ุงููุญุงุฏุซุฉ:\n"
    f"{memory_text}\n"

    f"โ ุงูุณุคุงู ุงูุญุงูู:\n{query}\n\n"
    "โ๏ธ ุงูุฅุฌุงุจุฉ:"
)

    return prompt